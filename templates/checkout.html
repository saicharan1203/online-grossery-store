{% extends "base.html" %}

{% block content %}
<div class="checkout-container">
    <h2>Checkout</h2>

    <div class="checkout-grid">
        <!-- Order Summary -->
        <div class="order-summary">
            <h3>Order Summary</h3>
            <div class="summary-items">
                {% for item in cart_items %}
                <div class="summary-item">
                    {% if item.product.image_url %}
                    <img src="{{ url_for('static', filename=item.product.image_url) }}" alt="{{ item.product.name }}"
                        class="summary-thumb">
                    {% endif %}
                    <div class="summary-details">
                        <h4>{{ item.product.name }}</h4>
                        <p>Qty: {{ item.quantity }} √ó ${{ "%.2f"|format(item.product.price) }}</p>
                    </div>
                    <div class="summary-price">
                        ${{ "%.2f"|format(item.product.price * item.quantity) }}
                    </div>
                </div>
                {% endfor %}
            </div>

            <div class="summary-total">
                <div class="d-flex justify-content-between mb-2">
                    <span>Subtotal:</span>
                    <span>${{ "%.2f"|format(total) }}</span>
                </div>
                <div id="discount-row" class="d-flex justify-content-between mb-2 text-success"
                    style="display: none !important;">
                    <span>Discount (<span id="coupon-code"></span>):</span>
                    <span>-$<span id="discount-amount">0.00</span></span>
                </div>
                <div class="d-flex justify-content-between fw-bold fs-5">
                    <span>Total Amount:</span>
                    <span class="total-price" id="final-total">${{ "%.2f"|format(total) }}</span>
                </div>
            </div>

            <!-- Coupon Section -->
            <div class="coupon-section mt-4">
                <label for="coupon-input" class="form-label">Have a coupon?</label>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="coupon-input" placeholder="Enter promo code">
                    <button class="btn btn-outline-primary" type="button" id="apply-coupon-btn">Apply</button>
                </div>
                <div id="coupon-message" class="form-text"></div>
            </div>

            <!-- Loyalty Points Redemption -->
            {% if current_user.is_authenticated and current_user.loyalty_points >= 50 %}
            <div class="loyalty-section mt-4">
                <div class="loyalty-header">
                    <label class="form-label">‚≠ê Loyalty Points</label>
                    <span class="points-badge">{{ current_user.loyalty_points }} points available</span>
                </div>
                <p class="loyalty-info">You have ‚Çπ{{ (current_user.loyalty_points / 100 * 10)|round(2) }} worth of
                    points!</p>
                <div class="input-group mb-3">
                    <input type="number" class="form-control" id="points-input" placeholder="Points to redeem" min="50"
                        max="{{ current_user.loyalty_points }}" step="10">
                    <button class="btn btn-outline-success" type="button" id="apply-points-btn">Redeem Points</button>
                </div>
                <small class="text-muted">100 points = ‚Çπ10 discount (minimum 50 points)</small>
                <div id="points-message" class="form-text"></div>
                <input type="hidden" id="redeemed-points" name="redeem_points" value="0">
            </div>
            {% endif %}
        </div>

        <!-- Payment Method Selection -->
        <div class="payment-section">
            <h3>Select Payment Method</h3>

            <form method="POST" action="{{ url_for('main.process_order') }}" id="checkout-form">
                <div class="payment-options">
                    <label class="payment-option">
                        <input type="radio" name="payment_method" value="Cash on Delivery" required>
                        <div class="payment-card">
                            <div class="payment-icon">üíµ</div>
                            <div class="payment-info">
                                <h4>Cash on Delivery</h4>
                                <p>Pay when you receive your order</p>
                            </div>
                        </div>
                    </label>

                    <label class="payment-option">
                        <input type="radio" name="payment_method" value="Debit Card" required>
                        <div class="payment-card">
                            <div class="payment-icon">üí≥</div>
                            <div class="payment-info">
                                <h4>Debit Card</h4>
                                <p>Pay securely with your debit card</p>
                            </div>
                        </div>
                    </label>

                    <label class="payment-option">
                        <input type="radio" name="payment_method" value="Credit Card" required>
                        <div class="payment-card">
                            <div class="payment-icon">üí≥</div>
                            <div class="payment-info">
                                <h4>Credit Card</h4>
                                <p>Pay securely with your credit card</p>
                            </div>
                        </div>
                    </label>

                    <label class="payment-option">
                        <input type="radio" name="payment_method" value="UPI" required>
                        <div class="payment-card">
                            <div class="payment-icon">üì±</div>
                            <div class="payment-info">
                                <h4>UPI</h4>
                                <p>Pay using UPI apps like GPay, PhonePe, Paytm</p>
                            </div>
                        </div>
                    </label>
                </div>

                <!-- Card Details Form (shown for Debit/Credit Card) -->
                <div id="card-details-form" class="card-details-section" style="display: none;">
                    <h4>üí≥ Enter Card Details</h4>
                    <div class="card-form">
                        <div class="form-group mb-3">
                            <label for="card_holder_name" class="form-label">Cardholder Name</label>
                            <input type="text" class="form-control" id="card_holder_name" name="card_holder_name"
                                placeholder="Name on card" autocomplete="cc-name">
                        </div>
                        <div class="form-group mb-3">
                            <label for="card_number" class="form-label">Card Number</label>
                            <input type="text" class="form-control" id="card_number" name="card_number"
                                placeholder="1234 5678 9012 3456" maxlength="19" autocomplete="cc-number">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="card_expiry" class="form-label">Expiry Date</label>
                                <input type="text" class="form-control" id="card_expiry" name="card_expiry"
                                    placeholder="MM/YY" maxlength="5" autocomplete="cc-exp">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="card_cvv" class="form-label">CVV</label>
                                <input type="password" class="form-control" id="card_cvv" name="card_cvv"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢" maxlength="4" autocomplete="cc-csc">
                            </div>
                        </div>
                        <div class="card-icons">
                            <span class="card-brand">Visa</span>
                            <span class="card-brand">Mastercard</span>
                            <span class="card-brand">RuPay</span>
                        </div>
                    </div>
                </div>

                <!-- Order Scheduling Section -->
                <div class="scheduling-section mt-4">
                    <h4>üìÖ Schedule Your Delivery (Optional)</h4>
                    <p class="text-muted">Choose when you want your groceries delivered</p>

                    <div class="schedule-grid">
                        <!-- Calendar Picker -->
                        <div class="calendar-container">
                            <label class="form-label">Delivery Date</label>
                            <div class="calendar-header">
                                <button type="button" class="calendar-nav" id="prev-month">&lt;</button>
                                <span class="calendar-title" id="calendar-title">December 2024</span>
                                <button type="button" class="calendar-nav" id="next-month">&gt;</button>
                            </div>
                            <div class="calendar-weekdays">
                                <span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span>
                            </div>
                            <div class="calendar-days" id="calendar-days">
                                <!-- Days will be filled by JavaScript -->
                            </div>
                            <input type="hidden" id="scheduled_date" name="scheduled_date">
                        </div>

                        <!-- Time Slots -->
                        <div class="timeslot-container">
                            <label class="form-label">Time Slot</label>
                            <div class="timeslot-grid">
                                <label class="timeslot-option">
                                    <input type="radio" name="delivery_time_slot" value="9:00 AM - 10:00 AM">
                                    <span class="timeslot-btn">9:00 AM - 10:00 AM</span>
                                </label>
                                <label class="timeslot-option">
                                    <input type="radio" name="delivery_time_slot" value="10:00 AM - 11:00 AM">
                                    <span class="timeslot-btn">10:00 AM - 11:00 AM</span>
                                </label>
                                <label class="timeslot-option">
                                    <input type="radio" name="delivery_time_slot" value="12:00 AM - 12:00 AM">
                                    <span class="timeslot-btn">12:00 AM - 12:00 PM</span>
                                </label>
                                <label class="timeslot-option">
                                    <input type="radio" name="delivery_time_slot" value="12:00 AM - 2:00 PM">
                                    <span class="timeslot-btn">12:00 PM - 2:00 PM</span>
                                </label>
                                <label class="timeslot-option">
                                    <input type="radio" name="delivery_time_slot" value="1:00 PM - 2:00 PM">
                                    <span class="timeslot-btn">1:00 PM - 2:00 PM</span>
                                </label>
                                <label class="timeslot-option">
                                    <input type="radio" name="delivery_time_slot" value="2:00 PM - 3:00 PM">
                                    <span class="timeslot-btn">2:00 PM - 3:00 PM</span>
                                </label>
                            </div>

                            <div class="recurring-options mt-3">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="is_recurring"
                                        name="is_recurring">
                                    <label class="form-check-label" for="is_recurring">
                                        Make this a recurring order
                                    </label>
                                </div>
                                <div id="recurrence-frequency" style="display: none;">
                                    <label for="recurrence_frequency" class="form-label">Frequency</label>
                                    <select class="form-control" id="recurrence_frequency" name="recurrence_frequency">
                                        <option value="daily">Daily</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="checkout-actions">
                    <a href="{{ url_for('main.cart') }}" class="btn btn-secondary">Back to Cart</a>
                    <button type="submit" class="btn btn-primary">Pay</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let pointsDiscount = 0;
    let couponDiscount = 0;
    const originalTotal = {{ total }};

    // Payment method selection - show/hide card details
    const paymentRadios = document.querySelectorAll('input[name="payment_method"]');
    const cardDetailsForm = document.getElementById('card-details-form');
    const cardInputs = cardDetailsForm ? cardDetailsForm.querySelectorAll('input') : [];

    paymentRadios.forEach(radio => {
        radio.addEventListener('change', function () {
            if (this.value === 'Debit Card' || this.value === 'Credit Card') {
                cardDetailsForm.style.display = 'block';
                // Make card inputs required
                cardInputs.forEach(input => input.required = true);
            } else {
                cardDetailsForm.style.display = 'none';
                // Remove required from card inputs
                cardInputs.forEach(input => {
                    input.required = false;
                    input.value = '';
                });
            }
        });
    });

    // Card number formatting (add spaces every 4 digits)
    const cardNumberInput = document.getElementById('card_number');
    if (cardNumberInput) {
        cardNumberInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
            let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formatted;
        });
    }

    // Expiry date formatting (MM/YY)
    const cardExpiryInput = document.getElementById('card_expiry');
    if (cardExpiryInput) {
        cardExpiryInput.addEventListener('input', function (e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2, 4);
            }
            e.target.value = value;
        });
    }

    // CVV - only allow numbers
    const cardCvvInput = document.getElementById('card_cvv');
    if (cardCvvInput) {
        cardCvvInput.addEventListener('input', function (e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });
    }

    // Coupon application
    document.getElementById('apply-coupon-btn').addEventListener('click', function () {
        const code = document.getElementById('coupon-input').value;
        const messageEl = document.getElementById('coupon-message');

        if (!code) {
            messageEl.textContent = 'Please enter a code';
            messageEl.className = 'form-text text-danger';
            return;
        }

        fetch('{{ url_for("main.apply_coupon") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: 'code=' + encodeURIComponent(code)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageEl.textContent = data.message;
                    messageEl.className = 'form-text text-success';

                    couponDiscount = data.discount;
                    document.getElementById('discount-row').style.setProperty('display', 'flex', 'important');
                    document.getElementById('coupon-code').textContent = data.code;
                    document.getElementById('discount-amount').textContent = data.discount.toFixed(2);
                    updateTotal();
                } else {
                    messageEl.textContent = data.message;
                    messageEl.className = 'form-text text-danger';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                messageEl.textContent = 'An error occurred';
                messageEl.className = 'form-text text-danger';
            });
    });

    // Points redemption
    const applyPointsBtn = document.getElementById('apply-points-btn');
    if (applyPointsBtn) {
        applyPointsBtn.addEventListener('click', function () {
            const points = parseInt(document.getElementById('points-input').value) || 0;
            const messageEl = document.getElementById('points-message');

            if (points < 50) {
                messageEl.textContent = 'Minimum 50 points required';
                messageEl.className = 'form-text text-danger';
                return;
            }

            // Calculate points discount (100 points = ‚Çπ10)
            pointsDiscount = (points / 100) * 10;
            document.getElementById('redeemed-points').value = points;
            messageEl.textContent = `${points} points = ‚Çπ${pointsDiscount.toFixed(2)} discount applied!`;
            messageEl.className = 'form-text text-success';
            updateTotal();
        });
    }

    // Update total with both discounts
    function updateTotal() {
        const totalDiscount = couponDiscount + pointsDiscount;
        const newTotal = Math.max(0, originalTotal - totalDiscount);
        document.getElementById('final-total').textContent = '‚Çπ' + newTotal.toFixed(2);
    }

    // Recurring order toggle
    const recurringCheckbox = document.getElementById('is_recurring');
    const recurrenceFrequency = document.getElementById('recurrence-frequency');

    if (recurringCheckbox && recurrenceFrequency) {
        recurringCheckbox.addEventListener('change', function () {
            recurrenceFrequency.style.display = this.checked ? 'block' : 'none';
        });
    }

    // Calendar functionality
    let currentDate = new Date();
    let selectedDate = null;
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const minDate = new Date(today);
    minDate.setDate(minDate.getDate() + 1); // Tomorrow is the minimum

    const calendarTitle = document.getElementById('calendar-title');
    const calendarDays = document.getElementById('calendar-days');
    const prevMonthBtn = document.getElementById('prev-month');
    const nextMonthBtn = document.getElementById('next-month');
    const scheduledDateInput = document.getElementById('scheduled_date');

    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'];

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        calendarTitle.textContent = `${monthNames[month]} ${year}`;

        // Get first day of month and total days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        let html = '';

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
            const day = daysInPrevMonth - i;
            html += `<span class="calendar-day other-month">${day}</span>`;
        }

        // Current month days
        for (let day = 1; day <= daysInMonth; day++) {
            const dateObj = new Date(year, month, day);
            const isPast = dateObj < minDate;
            const isSelected = selectedDate &&
                dateObj.getFullYear() === selectedDate.getFullYear() &&
                dateObj.getMonth() === selectedDate.getMonth() &&
                dateObj.getDate() === selectedDate.getDate();
            const isToday = dateObj.getTime() === today.getTime();

            let classes = 'calendar-day';
            if (isPast) classes += ' disabled';
            if (isSelected) classes += ' selected';
            if (isToday) classes += ' today';

            html += `<span class="${classes}" data-date="${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}">${day}</span>`;
        }

        // Next month days to fill the grid
        const totalCells = firstDay + daysInMonth;
        const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let i = 1; i <= remainingCells; i++) {
            html += `<span class="calendar-day other-month">${i}</span>`;
        }

        calendarDays.innerHTML = html;

        // Add click handlers
        calendarDays.querySelectorAll('.calendar-day:not(.disabled):not(.other-month)').forEach(dayEl => {
            dayEl.addEventListener('click', function () {
                calendarDays.querySelectorAll('.calendar-day').forEach(d => d.classList.remove('selected'));
                this.classList.add('selected');
                selectedDate = new Date(this.dataset.date);
                scheduledDateInput.value = this.dataset.date;
            });
        });
    }

    prevMonthBtn.addEventListener('click', function () {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
    });

    nextMonthBtn.addEventListener('click', function () {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
    });

    // Initial render
    renderCalendar();
</script>
{% endblock %}