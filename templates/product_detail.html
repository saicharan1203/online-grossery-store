{% extends "base.html" %}

{% block content %}
<div class="product-detail-container">
    <div class="product-detail-grid">
        <!-- Product Image Section -->
        <div class="product-image-section">
            <div class="main-image-container">
                {% if product.image_url %}
                <img src="{{ url_for('static', filename=product.image_url) }}" alt="{{ product.name }}"
                    class="main-product-image" id="mainImage">
                {% else %}
                <div class="no-image-placeholder">No Image Available</div>
                {% endif %}
            </div>
        </div>

        <!-- Product Info Section -->
        <div class="product-info-section">
            <div class="breadcrumb">
                <a href="{{ url_for('main.index') }}">Home</a> /
                <a href="{{ url_for('main.index', category=product.category) }}">{{ product.category }}</a> /
                <span>{{ product.name }}</span>
            </div>

            <h1 class="product-detail-title">{{ product.name }}</h1>

            <!-- Rating -->
            {% if product.review_count > 0 %}
            <div class="product-detail-rating">
                <div class="stars-large">
                    {% for i in range(5) %}
                    <span class="star {% if i < product.average_rating %}filled{% endif %}">★</span>
                    {% endfor %}
                </div>
                <span class="rating-text-large">{{ "%.1f"|format(product.average_rating) }} ({{ product.review_count }}
                    reviews)</span>
            </div>
            {% endif %}

            <p class="product-detail-price">${{ "%.2f"|format(product.price) }}</p>

            <p class="product-category-badge">{{ product.category }}</p>

            {% if product.description %}
            <p class="product-description">{{ product.description }}</p>
            {% endif %}

            <!-- Add to Cart and Wishlist Buttons -->
            {% if current_user.is_authenticated %}
            <div class="product-actions">
                <button class="btn btn-primary add-to-cart-detail" data-product-id="{{ product.id }}">
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    Add to Cart
                </button>
                <button class="btn btn-wishlist {% if in_wishlist %}active{% endif %}"
                    data-product-id="{{ product.id }}">
                    <svg viewBox="0 0 24 24" width="20" height="20"
                        fill="{% if in_wishlist %}currentColor{% else %}none{% endif %}">
                        <path
                            d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span class="wishlist-text">{{ 'In Wishlist' if in_wishlist else 'Add to Wishlist' }}</span>
                </button>
            </div>
            {% else %}
            <p class="login-prompt">
                <a href="{{ url_for('main.login') }}">Login</a> to add items to cart or wishlist
            </p>
            {% endif %}

            <!-- Stock Info -->
            <div class="stock-info">
                {% if product.stock > 10 %}
                <span class="in-stock">✓ In Stock ({{ product.stock }} available)</span>
                {% elif product.stock > 0 %}
                <span class="low-stock">⚠ Only {{ product.stock }} left!</span>
                {% else %}
                <span class="out-of-stock">✗ Out of Stock</span>
                {% endif %}
            </div>

            {% if product.detailed_description %}
            <div class="product-detailed-description">
                <h3>About this product</h3>
                <p>{{ product.detailed_description }}</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="reviews-section">
        <h2>Customer Reviews</h2>

        {% if current_user.is_authenticated %}
        <div class="review-form-container">
            <h3>Write a Review</h3>
            <form method="POST" action="{{ url_for('main.add_review', product_id=product.id) }}" class="review-form">
                <div class="rating-input">
                    <label>Your Rating:</label>
                    <div class="star-rating-input">
                        <input type="radio" name="rating" value="5" id="star5" required>
                        <label for="star5">★</label>
                        <input type="radio" name="rating" value="4" id="star4">
                        <label for="star4">★</label>
                        <input type="radio" name="rating" value="3" id="star3">
                        <label for="star3">★</label>
                        <input type="radio" name="rating" value="2" id="star2">
                        <label for="star2">★</label>
                        <input type="radio" name="rating" value="1" id="star1">
                        <label for="star1">★</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="comment">Your Review:</label>
                    <textarea name="comment" id="comment" rows="4"
                        placeholder="Share your experience with this product..."></textarea>
                </div>

                <button type="submit" class="btn btn-primary">Submit Review</button>
            </form>
        </div>
        {% endif %}

        <div class="reviews-list">
            {% if reviews %}
            {% for review in reviews %}
            <div class="review-card">
                <div class="review-header">
                    <div class="review-author">
                        <strong>{{ review.user.username }}</strong>
                        <span class="review-date">{{ review.created_at.strftime('%B %d, %Y') }}</span>
                    </div>
                    <div class="review-stars">
                        {% for i in range(5) %}
                        <span class="star {% if i < review.rating %}filled{% endif %}">★</span>
                        {% endfor %}
                    </div>
                </div>
                {% if review.comment %}
                <p class="review-comment">{{ review.comment }}</p>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <p class="no-reviews">No reviews yet. Be the first to review this product!</p>
            {% endif %}
        </div>
    </div>

    <!-- Related Products -->
    {% if related_products %}
    <div class="related-products-section">
        <h2>Related Products</h2>
        <div class="related-products-grid">
            {% for related in related_products %}
            <div class="related-product-card">
                <a href="{{ url_for('main.product_detail', product_id=related.id) }}">
                    {% if related.image_url %}
                    <img src="{{ url_for('static', filename=related.image_url) }}" alt="{{ related.name }}">
                    {% endif %}
                    <h4>{{ related.name }}</h4>
                    <p class="price">${{ "%.2f"|format(related.price) }}</p>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    // Add to cart from detail page
    document.querySelector('.add-to-cart-detail')?.addEventListener('click', function () {
        const productId = this.getAttribute('data-product-id');

        fetch(`/add_to_cart/${productId}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message);
                    updateCartNav(data.cart_total);
                }
            })
            .catch(error => console.error('Error:', error));
    });

    // Wishlist toggle
    document.querySelector('.btn-wishlist')?.addEventListener('click', function () {
        const productId = this.getAttribute('data-product-id');

        fetch(`/wishlist/toggle/${productId}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.classList.toggle('active');
                    this.querySelector('.wishlist-text').textContent = data.in_wishlist ? 'In Wishlist' : 'Add to Wishlist';
                    showToast(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    });
</script>
{% endblock %}